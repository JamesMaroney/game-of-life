<!DOCTYPE html>
<html>
  <head>

    <style>
      html, body { height: 100%; padding: 0; margin: 0}
      #gameboard { height: 100%; }
      table { border-collapse: collapse; border: 1px solid #000; width: 100%; height: 100%; }
      td { background: #fff; }
      td.living { background: #000; }
    </style>
  </head>

  <body>

    <div id="gameboard"></div>

    <script>
      GameOfLife = (function(){
        GameOfLife = function(container, options){
          this.options = options;

          this.gameboard = drawGameboard(container, options.width, options.height);

          this.engine = new Worker('engine.js');
          this.engine.addEventListener('message', receiveMessage.bind(this));
        }

        var receiveMessage = function(msg){
          if(msg.data.cmd && msg.data.cmd == 'log'){
            msg.data.args.unshift('From Engine: ');
            console.log.apply(console,msg.data.args);
          } else {
            console.log('saving new generation');
            this.nextGeneration = msg.data;
          }
        }

        var drawGameboard = function(container, width, height){
          var fragment = document.createDocumentFragment();
          var table = fragment.appendChild(document.createElement('table'));
          var gameboard = [];

          var row, cell;
          for(var j = 0; j<height; j++){
            row = table.appendChild(document.createElement('tr'));
            for(var i = 0; i<width; i++){
              (function(i,j){
                cell = row.appendChild(document.createElement('td'));
                gameboard[i] = gameboard[i] || [];
                gameboard[i][j] = cell;
              })(i,j);
            }
          }
          container.appendChild(fragment);
          return gameboard;
        }

        var drawGeneration = function(){
          console.log('drawing generation');
          requestAnimationFrame(drawGeneration.bind(this));
          if(!this.nextGeneration) return;
          console.log('found generation');
          nextGeneration = this.nextGeneration;
          this.nextGeneration = undefined;
          for(var i=0; i<this.options.width; i++){
            for(var j=0; j<this.options.height; j++){
              this.gameboard[i][j].className = nextGeneration[i][j] ? "living" : "";
            }
          }
        }

        GameOfLife.prototype.start = function(){
          console.log('Starting the Game of Life. ', this.gameboard, this.options);
          var game = this;
          this.engine.postMessage({cmd: 'start', options: this.options});
          requestAnimationFrame(drawGeneration.bind(this));
        }


        return GameOfLife
      })()

      new GameOfLife(document.getElementById('gameboard'), {seed: null, width: 500, height: 500}).start();
    </script>
  </body>
</html>
