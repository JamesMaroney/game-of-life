<!DOCTYPE html>
<html>
  <head>

    <style>
      html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: #343434; }
      #gameboard { text-align: center; height: 100%; width: 100%; }
      #gameboard:after { content: ' '; width: 0; height: 100%; display: inline-block; vertical-align: middle; }
      canvas { display: inline-block; vertical-align: middle; border: 1px solid #000; box-shadow: 0 0 50px #333; }
    </style>
  </head>

  <body>

    <div id="gameboard"></div>

    <script>
      GameOfLife = (function(){
        var scale = 3;
        GameOfLife = function(container, options){
          this.options = options;

          this.drawingContext = drawGameboard(container, options.width, options.height);

          this.engine = new Worker('engine.js');
          this.engine.addEventListener('message', receiveMessage.bind(this));
        }

        var receiveMessage = function(msg){
          if(msg.data.cmd && msg.data.cmd == 'log'){
            msg.data.args.unshift('From Engine: ');
            console.log.apply(console,msg.data.args);
          } else {
            //console.log('saving new generation');
            this.nextGeneration = msg.data;
          }
        }

        var drawGameboard = function(container, width, height){
          var canvas = document.createElement('canvas');
          canvas.setAttribute('height', height * scale);
          canvas.setAttribute('width', width * scale);
          container.appendChild(canvas);
          return canvas.getContext('2d');
        }

        fillStyles = {
          10: 'rgb(0,0,0)',     // Human
          1: 'rgb(255,0,0)',    // Zombie
          0: 'rgb(255,255,255)' // Empty
        };
        var drawGeneration = function(){
          //console.log('drawing generation');
          if(!this.nextGeneration || !this.drawingContext){ requestAnimationFrame(drawGeneration.bind(this)); return; }
          //console.log('found generation');
          nextGeneration = this.nextGeneration;
          this.nextGeneration = undefined;
          for(var i=0; i<this.options.width; i++){
            for(var j=0; j<this.options.height; j++){
              this.drawingContext.fillStyle = fillStyles[nextGeneration[i][j]];
              this.drawingContext.fillRect(i*scale,j*scale,scale,scale);
            }
          }
          requestAnimationFrame(drawGeneration.bind(this));
        }

        GameOfLife.prototype.start = function(){
          //console.log('Starting the Game of Life. ', this.gameboard, this.options);
          var game = this;
          this.engine.postMessage({cmd: 'start', options: this.options});
          requestAnimationFrame(drawGeneration.bind(this));
        }


        return GameOfLife
      })()

      new GameOfLife(document.getElementById('gameboard'), {seed: null, width: 200, height: 200}).start();
    </script>
  </body>
</html>
