<!DOCTYPE html>
<html>
  <head>

    <style>
      html, body { height: 100%; padding: 0; margin: 0}
      #gameboard { height: 100%; }
      table { border-collapse: collapse; border: 1px solid #000; width: 100%; height: 100%; }
      td { background: #fff; }
      td.living { background: #000; }
    </style>
  </head>

  <body>

    <div id="gameboard"></div>

    <script>
      GameOfLife = (function(){
        var scale = 3;
        GameOfLife = function(container, options){
          this.options = options;

          this.drawingContext = drawGameboard(container, options.width, options.height);

          this.engine = new Worker('engine.js');
          this.engine.addEventListener('message', receiveMessage.bind(this));
        }

        var receiveMessage = function(msg){
          if(msg.data.cmd && msg.data.cmd == 'log'){
            msg.data.args.unshift('From Engine: ');
            console.log.apply(console,msg.data.args);
          } else {
            console.log('saving new generation');
            this.nextGeneration = msg.data;
          }
        }

        var drawGameboard = function(container, width, height){
          var canvas = document.createElement('canvas');
          canvas.setAttribute('height', height * scale);
          canvas.setAttribute('width', width * scale);
          container.appendChild(canvas);
          return canvas.getContext('2d');
        }

        var livingFillStyle = 'rgb(0,0,0)';
        var deadFillStyle = 'rgb(255,255,255)';
        var drawGeneration = function(){
          console.log('drawing generation');
          if(!this.nextGeneration || !this.drawingContext){ requestAnimationFrame(drawGeneration.bind(this)); return; }
          console.log('found generation');
          nextGeneration = this.nextGeneration;
          this.nextGeneration = undefined;
          for(var i=0; i<this.options.width; i++){
            for(var j=0; j<this.options.height; j++){
              this.drawingContext.fillStyle = _fillStyle = nextGeneration[i][j] ? livingFillStyle : deadFillStyle;
              this.drawingContext.fillRect(i*scale,j*scale,scale,scale);
            }
          }
          requestAnimationFrame(drawGeneration.bind(this));
        }

        GameOfLife.prototype.start = function(){
          console.log('Starting the Game of Life. ', this.gameboard, this.options);
          var game = this;
          this.engine.postMessage({cmd: 'start', options: this.options});
          requestAnimationFrame(drawGeneration.bind(this));
        }


        return GameOfLife
      })()

      new GameOfLife(document.getElementById('gameboard'), {seed: null, width: 200, height: 200}).start();
    </script>
  </body>
</html>
